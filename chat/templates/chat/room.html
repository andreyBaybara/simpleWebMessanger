{% extends 'base.html' %}
{% load staticfiles %}
{% block content %}
<h3 class=" text-center">Messaging</h3>
<div id="chatErrors"></div>
<div class="messaging">
  <div class="inbox_msg">
    <div class="inbox_people">
      <div class="headind_srch">
        <div class="recent_heading">
          <h5>{{ request.user.username }} {{ request.user.mobile_phone }}</h5>
        </div>
      </div>
      <div class="inbox_chat">
          {% for chat, messages in user_chats.items %}
                <div id="{{ chat }}" username="
                  {% if messages.0.user1.pk != request.user.pk %}
                    {{ messages.0.user1.username }}
                  {% else %}
                    {{ messages.0.user2.username }} {% endif %}" class="chat_list client-choose-sidebar-item">
                  <div class="chat_people">
                    <div class="chat_img"> <img src="{% static 'images/chat_icon.png' %}" alt="user"> </div>
                    <div class="chat_ib">
                      <h5>
                        {% if messages.0.user1.pk != request.user.pk %}
                          {{ messages.0.user1.username }}
                        {% else %}
                          {{ messages.0.user2.username }}
                        {% endif %}<span class="chat_date">Dec 25</span></h5>
                      <p><span id="message_to_read_{{ chat }}" class="badge"></span></p>
                    </div>
                  </div>
                </div>
          {% endfor %}
      </div>
    </div>
    <div class="mesgs">
        {% for chat, messages in user_chats.items %}
              <div style="display:none!important" id="message_box_{{ chat }}" class="msg_history">
                {% for message in messages %}
                    {% if message.index > 0 %}
                      {% if message.sender == user_pk %}
                        <div msg_index="{{ message.index }}" class="outgoing_msg">
                          <div class="sent_msg">
                            <p>{{ message.message }}</p>
                            <span class="time_date"> {{ message.datetime }}</span></div>
                        </div>
                      {% else %}
                        <div msg_index="{{ message.index }}" class="incoming_msg">
                          <div class="received_msg">
                            <div class="received_withd_msg">
                              <p>{{ message.message }}</p>
                              <span class="time_date"> {{ message.datetime }}</span></div>
                          </div>
                        </div>
                      {% endif %}
                    {% endif %}
                {% endfor %}
              </div>
        {% endfor %}
      <div class="type_msg">
        <div class="input_msg_write">
          <input id="chat-message-input"  type="text" class="write_msg" placeholder="Написать сообщение" />
          <button id="chat-message-submit"  class="msg_send_btn" type="button"><i class="fa fa-paper-plane-o" aria-hidden="true"></i></button>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="row">
    <div class="col-md-offset-8 col-md-1">
        <a href="{% url 'logout' %}">
            <button type="button" class="btn btn-success">Выйти</button>
        </a>
    </div>
    <div class="col-md-3">
        <button class="btn btn-primary" data-toggle="modal" data-target="#addFriendModal">
            Добавить друга
        </button>
    </div>
</div>
{% endblock content%}

{% block modal %}
<div class="modal fade" id="addFriendModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h4 class="modal-title" id="myModalLabel">Добавить друга</h4>
          </div>
          <div class="modal-body">
              <h4>Пример ввода: 380955081131</h4>
              <form role="form">
              <div class="form-group">
                <label for="mobilePhone">Phone</label>
                <input required type="phone" class="form-control" id="mobilePhone" placeholder="Номер телефона">
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Закрыть</button>
            <button id="add_friend" type="button" class="btn btn-primary">Найти и добавить</button>
          </div>
        </div>
    </div>
</div>
{% endblock modal%}
{% block js %}
<script>
    $(document).ready(function(){
      var user_id = {{ request.user.pk }};
      var chat = createChat(user_id);
      chat.init();
    });
    function send_ajax_request(request_url, data, success_func) {
        $.ajax({
            url: request_url,
            type: 'POST',
            dataType: 'json',
            data: data,
            success: function(ajax_response) {
                success_func(ajax_response);
            },
            error: function (xhr, ajaxOptions, thrownError) {
                   console.log(xhr.status);
                console.log(thrownError);
            }
        });
    }
    function createChat(user_id) {
      var chat = {
        init: function () {
          this.user_id = user_id;
          this.chat_socket = new WebSocket(
                  'ws://' + window.location.host +
                  '/ws/chat/' + user_id + '/');
          that = this;
          this.add_events();
        },
        add_events: function() {
          this.chat_socket.onmessage = this.onMessage;
          this.chat_socket.onclose = this.onClose;

          $('#chat-message-submit').on('click', this.sendMessage);
          $('#chat-message-input').on('keyup', function(e) {
              if (e.keyCode === 13) {  // enter, return
                  $('#chat-message-submit').click();
              }
          });
          $('.client-choose-sidebar-item').on('click', this.chooseSidebarItem);
          $('#add_friend').on('click', this.addFriendRequest);
        },
        wrappMessageOutgoing: function(message) { // TODO change this function without html code
          return '<div class="outgoing_msg">' +
                  '<div class="sent_msg">' +
                    '<p>' + message + '</p>' +
                    '<span class="time_date">' + new Date().toISOString() + '</span> </div>' +
                  '</div>';
        },
        wrappMessageIncoming: function(message) { // TODO change this function without html code
            return '<div class="incoming_msg">' +
                      '<div class="received_msg">' +
                        '<div class="received_withd_msg">' +
                          '<p>' + message + '</p>' +
                          '<span class="time_date">' + new Date().toISOString() + '</span></div>' +
                      '</div>' +
                    '</div>';
        },
        wrappNewFriend: function(data) { // TODO change this function without html code
           return '<div id="'+data['chat_key']+'" username="'+data['new_friend_data']['username']+'" class="chat_list client-choose-sidebar-item">' +
                      '<div class="chat_people">'+
                        '<div class="chat_img"> <img src="{% static 'images/chat_icon.png'%}" alt=""> </div>' +
                        '<div class="chat_ib">' +
                          '<h5>' + data['new_friend_data']['username'] +
                            '<span class="chat_date">Dec 25</span></h5>' +
                          '<p>'  +'<span id="message_to_read_' + data['chat_key'] + '" class="badge"></span></p>' +
                        '</div>' +
                      '</div>' +
                    '</div>';
        },
        wrapMsgBox: function(data) { // TODO change this function without html code
            return '<div style="display:none!important" id="message_box_' + data['chat_key'] +'" class="msg_history"></div>'
        },
        scrollMessageBoxDown: function(chat_key) {
          var message_box = $('#message_box_' + chat_key);
          var scroll_height = message_box.prop("scrollHeight");
          message_box.scrollTop(scroll_height);
        },
        wrapError: function(message) {
            var html = '<div class="alert alert-danger">' + message + '</div>';
            return html;
        },
        onMessage: function(e) {
            var data = JSON.parse(e.data);
            var message = data['message'];
            var sender_id = data['user_id'];
            var chat_key = data['chat_key'];
            if (sender_id == that.user_id ) { // if sender is current user this is outgoing message
                var message_item = that.wrappMessageOutgoing(message);
            } else {
                var message_item = that.wrappMessageIncoming(message);
            }
            var message_box = $('#message_box_' + chat_key);
            var messages = message_box.html() + message_item;
            message_box.html(messages);
            that.scrollMessageBoxDown(chat_key);
        },
        onClose: function(e) {
            console.error('Chat socket closed unexpectedly');
        },
        sendMessage: function(e) {
            var message_input = $('#chat-message-input');
            var message = message_input.val();
            var active_chat = $('.active_chat').attr('id');
            if(active_chat) {
                that.chat_socket.send(JSON.stringify({
                    'message': message,
                    'chat_key': active_chat,
                    'sender_id': this.user_id
                }));
                message_input.val('');
            } else {
                console.log('Please choose receiver');
            }
        },
        chooseSidebarItem: function(event) {
            event.preventDefault();
            chat_key = $( this ).attr('id');
            that.resetSidebarActive();
            that.hideAllMessageBox();
            $( this ).addClass('active_chat');
            that.showChatMessageBox(chat_key);
            $('#chat-message-input').focus();
        },
        resetSidebarActive: function() {
            $('.client-choose-sidebar-item').each(function( index ) {
              $( this ).removeClass('active_chat');
            });
        },
        hideAllMessageBox: function() {
            $('.msg_history').each(function( index ) {
              $( this ).css('display', 'none');
            });
        },
        showChatMessageBox: function(chat_key) {
            $('#message_box_' + chat_key).css('display', 'block');
        },
        addFriendRequest: function() {
            var data = {
                'new_friend_phone': $('#mobilePhone').val(),
                'adding_user_phone': "{{ request.user.mobile_phone }}",
            };
            var url = "{% url 'add_friend' %}";
            send_ajax_request(url, data, that.addFriendResponse);
        },
        addFriendResponse: function(data) {
            console.log(data);
            if(data['status'] == 'created') {
                var inbox_chat_html = $('.inbox_chat').html();
                var new_friend_html = that.wrappNewFriend(data);
                inbox_chat_html += new_friend_html;
                $('.inbox_chat').html(inbox_chat_html);
                $('.mesgs').html(that.wrapMsgBox(data) + $('.mesgs').html());
                $('#addFriendModal').modal('hide');
                that.updateEvents();
            }
            if(data['status'] == 'fail') {
                $('#addFriendModal').modal('hide');
                var innerHTML = '';
                data['messages'].forEach(function(message) {
                   console.log(message);
                   innerHTML += that.wrapError(message);
                });
                $('#chatErrors').html(innerHTML);
                $('#chatErrors').show();
                $('#chatErrors').fadeOut(10000);
            }
        },
        updateEvents: function() {
          $('.client-choose-sidebar-item').on('click', that.chooseSidebarItem);
          $('#chat-message-submit').on('click', that.sendMessage);
          $('#chat-message-input').on('keyup', function(e) {
              if (e.keyCode === 13) {  // enter, return
                  $('#chat-message-submit').click();
              }
          });
        },
        chat_socket: '',
        user_id: ''
      }
      return chat;
    }
</script>
{% endblock js %}
